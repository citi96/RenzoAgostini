@if (IsVisible)
{
    <div class="lightbox-overlay @(isFullscreen ? "fullscreen" : "")" @onclick="HandleOverlayClick" @onkeydown="HandleKeyDown" tabindex="0">
        <div class="lightbox-container" @onclick:stopPropagation="true">

            <!-- Header -->
            <div class="lightbox-header">
                <h3 class="lightbox-title">@Title</h3>
                @if (Images.Count > 1)
                {
                    <div class="lightbox-counter">@(CurrentIndex + 1) di @Images.Count</div>
                }
                <button class="lightbox-close" @onclick="Close" title="Chiudi (Esc)">
                    <Icon Name="close" />
                </button>
            </div>

            <!-- Main Content -->
            <div class="lightbox-content">
                <!-- Info Toggle Button -->
                <button class="lightbox-info-toggle" @onclick="ToggleInfo" title="Mostra/Nascondi Info (I)">
                    <Icon Name="info" />
                </button>

                <!-- Image Container -->
                <div class="lightbox-image-container">
                    @if (isImageLoading)
                    {
                        <div class="lightbox-loading">
                            <div class="lightbox-loading-spinner"></div>
                            <p>Caricamento...</p>
                        </div>
                    }

                    @if (Images.Any() && CurrentIndex < Images.Count)
                    {
                        <img src="@GetCurrentImageUrl()"
                             alt="@Title"
                             class="lightbox-image @(isZoomed ? "zoomed" : "")"
                             @onclick="ToggleZoom"
                             @onload="OnImageLoaded"
                             @onerror="OnImageError"
                             style="@(isImageLoading ? "display: none;" : "")" />
                    }
                </div>

                <!-- Navigation Buttons -->
                @if (Images.Count > 1)
                {
                    <button class="lightbox-nav lightbox-nav-prev"
                            @onclick="PreviousImage"
                            disabled="@(CurrentIndex == 0 && !isLooping)"
                            title="Immagine Precedente (←)">
                        <Icon Name="chevron-left" />
                    </button>
                    <button class="lightbox-nav lightbox-nav-next"
                            @onclick="NextImage"
                            disabled="@(CurrentIndex == Images.Count - 1 && !isLooping)"
                            title="Immagine Successiva (→)">
                        <Icon Name="chevron-right" />
                    </button>
                }

                <!-- Zoom Controls -->
                <div class="lightbox-controls">
                    <button class="lightbox-control" @onclick="ToggleZoom" title="Zoom (Z)">
                        @if (isZoomed)
                        {
                            <Icon Name="zoom-out" />
                        }
                        else
                        {
                            <Icon Name="zoom-in" />
                        }
                    </button>
                    <button class="lightbox-control" @onclick="ToggleFullscreen" title="Schermo Intero (F)">
                        @if (isFullscreen)
                        {
                            <Icon Name="exit-fullscreen" />
                        }
                        else
                        {
                            <Icon Name="fullscreen" />
                        }
                    </button>
                    @if (Images.Count > 1)
                    {
                        <button class="lightbox-control" @onclick="StartSlideshow" title="Slideshow (S)" disabled="@isSlideshowActive">
                            <Icon Name="slideshow" />
                        </button>
                        @if (isSlideshowActive)
                        {
                            <button class="lightbox-control" @onclick="StopSlideshow" title="Ferma Slideshow">
                                <Icon Name="pause" />
                            </button>
                        }
                    }
                </div>

                <!-- Info Panel -->
                <div class="lightbox-info @(showInfo ? "visible" : "")">
                    <div class="lightbox-info-title">@Title</div>
                    <div class="lightbox-info-meta">
                        @if (ImageMetadata != null && ImageMetadata.ContainsKey(CurrentIndex))
                        {
                            var meta = ImageMetadata[CurrentIndex];
                            @if (!string.IsNullOrEmpty(meta.Year))
                            {
                                <span class="lightbox-info-badge">
                                    <Icon Name="calendar" />
                                    <span>@meta.Year</span>
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(meta.Medium))
                            {
                                <span class="lightbox-info-badge">
                                    <Icon Name="palette" />
                                    <span>@meta.Medium</span>
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(meta.Dimensions))
                            {
                                <span class="lightbox-info-badge">
                                    <Icon Name="ruler" />
                                    <span>@meta.Dimensions</span>
                                </span>
                            }
                        }
                        <span class="lightbox-info-badge">
                            <Icon Name="images" />
                            <span>@(CurrentIndex + 1) di @Images.Count</span>
                        </span>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div class="lightbox-shortcuts">
                    <div>ESC - Chiudi</div>
                    <div>← → - Naviga</div>
                    <div>Z - Zoom</div>
                    <div>F - Schermo Intero</div>
                    <div>I - Info</div>
                    @if (Images.Count > 1)
                    {
                        <div>S - Slideshow</div>
                    }
                </div>
            </div>

            <!-- Footer with Thumbnails -->
            @if (Images.Count > 1 && showThumbnails)
            {
                <div class="lightbox-footer">
                    <div class="lightbox-thumbnails">
                        @for (int i = 0; i < Images.Count; i++)
                        {
                            var index = i;
                            <img src="@GetThumbnailUrl(index)"
                                 alt="Miniatura @(index + 1)"
                                 class="lightbox-thumbnail @(index == CurrentIndex ? "active" : "")"
                                 @onclick="() => GoToImage(index)" />
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}