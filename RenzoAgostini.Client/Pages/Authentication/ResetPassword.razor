@page "/authentication/reset-password"
@layout LoginLayout
@using Microsoft.AspNetCore.WebUtilities
@using RenzoAgostini.Client.Services
@using RenzoAgostini.Client.Services.Interfaces
@using RenzoAgostini.Shared.DTOs
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Reimposta password · Renzo Agostini</PageTitle>

@if (!string.IsNullOrEmpty(infoMessage))
{
    <div class="kc-message info">@infoMessage</div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="kc-message error">@errorMessage</div>
}

<EditForm id="kc-reset-password" class="kc-form" Model="resetModel" OnValidSubmit="HandleReset">
    <DataAnnotationsValidator />

    <div class="kc-field">
        <label for="email">Email</label>
        <InputText id="email" @bind-Value="resetModel.Email" autocomplete="email" />
        <ValidationMessage For="@(() => resetModel.Email)" class="kc-field-error" />
    </div>

    <div class="kc-field">
        <label for="password">Nuova password</label>
        <InputText id="password" type="password" @bind-Value="resetModel.Password" autocomplete="new-password" />
        <ValidationMessage For="@(() => resetModel.Password)" class="kc-field-error" />
    </div>

    <div class="kc-field">
        <label for="confirm">Conferma password</label>
        <InputText id="confirm" type="password" @bind-Value="resetModel.ConfirmPassword" autocomplete="new-password" />
        <ValidationMessage For="@(() => resetModel.ConfirmPassword)" class="kc-field-error" />
    </div>

    <div class="kc-actions">
        <div class="kc-buttons">
            <button class="kc-btn primary" type="submit">Aggiorna password</button>
            <a class="kc-btn-link" href="authentication/login">Torna al login</a>
        </div>
    </div>
</EditForm>

@code {
    private readonly ResetPasswordDto resetModel = new();
    private string? errorMessage;
    private string? infoMessage;

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("email", out var email))
        {
            resetModel.Email = email.FirstOrDefault() ?? string.Empty;
        }

        if (query.TryGetValue("token", out var token))
        {
            resetModel.Token = token.FirstOrDefault() ?? string.Empty;
        }
    }

    private async Task HandleReset()
    {
        errorMessage = null;
        infoMessage = null;

        if (string.IsNullOrWhiteSpace(resetModel.Token))
        {
            errorMessage = "Link di reimpostazione non valido.";
            return;
        }

        var result = await AuthService.ResetPasswordAsync(resetModel);
        if (result)
        {
            infoMessage = "Password aggiornata con successo. Ora puoi effettuare l'accesso.";
            resetModel.Password = string.Empty;
            resetModel.ConfirmPassword = string.Empty;
        }
        else
        {
            errorMessage = "Non è stato possibile aggiornare la password. Controlla il link e riprova.";
        }
    }
}
