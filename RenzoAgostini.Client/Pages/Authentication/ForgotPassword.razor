@page "/authentication/forgot-password"
@layout LoginLayout
@using RenzoAgostini.Shared.DTOs
@using RenzoAgostini.Client.Services
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Password dimenticata · Renzo Agostini</PageTitle>

@if (!string.IsNullOrEmpty(infoMessage))
{
    <div class="kc-message info">@infoMessage</div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="kc-message error">@errorMessage</div>
}

<EditForm id="kc-reset-password-form" class="kc-form" Model="forgotModel" OnValidSubmit="HandleForgotPassword">
    <DataAnnotationsValidator />

    <div class="kc-field">
        <label for="email">Username o email</label>
        <InputText id="email" @bind-Value="forgotModel.Email" autocomplete="username" autofocus />
        <ValidationMessage For="@(() => forgotModel.Email)" class="kc-field-error" />
    </div>

    <div class="kc-actions">
        <div class="kc-buttons">
            <button class="kc-btn primary" type="submit">Invia</button>
            <a class="kc-btn-link" href="authentication/login">Torna al login</a>
        </div>
    </div>
</EditForm>

@code {
    private readonly ForgotPasswordDto forgotModel = new();
    private string? infoMessage;
    private string? errorMessage;

    private async Task HandleForgotPassword()
    {
        infoMessage = null;
        errorMessage = null;

        var result = await AuthService.RequestPasswordResetAsync(forgotModel.Email);
        if (result)
        {
            infoMessage = "Se l'email è registrata riceverai le istruzioni per reimpostare la password.";
            forgotModel.Email = string.Empty;
        }
        else
        {
            errorMessage = "Impossibile inviare le istruzioni in questo momento. Riprova più tardi.";
        }
    }
}
