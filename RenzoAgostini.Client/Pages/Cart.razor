@page "/cart"
@using System.Globalization

<PageTitle>Carrello - Galleria Agostini</PageTitle>

<div class="cart-container">
    <!-- Header -->
    <div class="cart-header">
        <h1 class="cart-title">Il Tuo Carrello</h1>
        <p class="cart-subtitle">
            @if (cartItems?.Any() == true)
            {
                <span>@cartItems.Count articolo@(cartItems.Count > 1 ? "i" : "") selezionato@(cartItems.Count > 1 ? "i" :
                "")</span>
            }
            else
            {
                <span>Nessun articolo nel carrello</span>
            }
        </p>
    </div>

    @if (isLoading)
    {
        <div class="cart-loading">
            <div class="cart-loading-spinner"></div>
            <p>Caricamento carrello...</p>
        </div>
    }
    else if (cartItems?.Any() != true)
    {
        <!-- Empty Cart -->
        <div class="empty-cart">
            <div class="empty-cart-icon"></div>
            <h2 class="empty-cart-title">Il Tuo Carrello è Vuoto</h2>
            <p class="empty-cart-description">
                Non hai ancora aggiunto nessun quadro al tuo carrello.
                Esplora la nostra galleria e trova l'opera perfetta per te.
            </p>
            <a href="/" class="start-shopping-btn">
                <span>Inizia a Comprare</span>
            </a>
        </div>
    }
    else
    {
        <!-- Cart Layout -->
        <div class="cart-layout">
            <!-- Cart Items -->
            <div class="cart-items">
                <div class="cart-items-header">
                    <h2 class="cart-items-title">Articoli (@cartItems.Count)</h2>
                    <button class="clear-cart-btn" @onclick="ClearCart" disabled="@isUpdating">
                        <span>Svuota Carrello</span>
                    </button>
                </div>

                <div class="cart-items-list">
                    @foreach (var item in cartItems)
                    {
                        <div class="cart-item">
                            <!-- Image -->
                            <div>
                                @if (item.ImageUrls.Any())
                                {
                                    <img src="@($"{Configuration["BaseUrl"]}/{item.ImageUrls[0]}")" alt="@item.Title"
                                        class="cart-item-image" />
                                }
                                else
                                {
                                    <div class="cart-item-image"
                                        style="background: var(--neutral-200); display: flex; align-items: center; justify-content: center; color: var(--neutral-500);">
                                        <!-- Placeholder -->
                                    </div>
                                }
                            </div>

                            <!-- Details -->
                            <div class="cart-item-details">
                                <h3 class="cart-item-title">@item.Title</h3>
                                <div class="cart-item-meta">
                                    @if (item.Year.HasValue)
                                    {
                                        <span>@item.Year</span>
                                    }
                                    @if (!string.IsNullOrEmpty(item.Medium))
                                    {
                                        <span>@item.Medium</span>
                                    }
                                </div>
                                <div class="cart-item-price">
                                    @item.Price?.ToString("C", CultureInfo.GetCultureInfo("it-IT"))
                                </div>
                            </div>

                            <!-- Remove Button -->
                            <button class="remove-item-btn" @onclick="() => RemoveItem(item.Id)" disabled="@isUpdating"
                                title="Rimuovi dal carrello">
                                &times;
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary">
                <div class="summary-card">
                    <div class="summary-header">
                        <h3 class="summary-title">Riepilogo Ordine</h3>
                    </div>

                    <div class="summary-body">
                        <div class="summary-row">
                            <span class="summary-label">Subtotale (@GetTotalItems() articoli)</span>
                            <span class="summary-value">@GetSubtotal().ToString("C",
                            CultureInfo.GetCultureInfo("it-IT"))</span>
                        </div>
                        <div class="summary-row shipping-row">
                            <span class="summary-label">Spedizione</span>
                            <span class="summary-value shipping-value">
                                @if (SelectedShippingOption is null)
                                {
                                    <span class="shipping-not-selected">Seleziona la modalità al checkout</span>
                                }
                                else
                                {
                                    <span class="shipping-option-name">@SelectedShippingOption.Name</span>
                                    <span class="shipping-option-price @(GetShipping() == 0 ? "free" : string.Empty)">
                                        @(GetShipping() == 0
                                            ? "Gratuita"
                                            : GetShipping().ToString("C", CultureInfo.GetCultureInfo("it-IT")))
                                    </span>
                                    @if (!string.IsNullOrWhiteSpace(SelectedShippingOption.EstimatedDelivery))
                                    {
                                        <span class="shipping-option-estimate">@SelectedShippingOption.EstimatedDelivery</span>
                                    }
                                }
                            </span>
                        </div>
                        @if (ShouldShowFreeShippingBanner())
                        {
                            <div class="summary-row shipping-incentive">
                                <span>Aggiungi @GetAmountForFreeShipping().ToString("C", CultureInfo.GetCultureInfo("it-IT"))
                                    per ottenere la spedizione gratuita con @SelectedShippingOption!.Name.</span>
                            </div>
                        }
                        <div class="summary-row">
                            <span class="summary-label">Totale stimato</span>
                            <span class="summary-value">@GetTotal().ToString("C",
                            CultureInfo.GetCultureInfo("it-IT"))</span>
                        </div>
                    </div>

                    <div class="summary-actions">
                        <button class="checkout-btn" @onclick="GoToCheckout" disabled="@(!cartItems.Any() || isUpdating)">
                            @if (isUpdating)
                            {
                                <span>Aggiornamento...</span>
                            }
                            else
                            {
                                <span>Procedi al Checkout</span>
                            }
                        </button>

                        <a href="/" class="continue-shopping-btn">
                            <span>Continua lo Shopping</span>
                        </a>
                    </div>
                </div>

                <!-- Free Shipping Banner -->
                @if (ShouldShowFreeShippingBanner())
                {
                    <div class="free-shipping-banner">
                    <div class="free-shipping-banner">
                        <div class="free-shipping-title">Spedizione Gratuita</div>
                        <div class="free-shipping-text">
                            Ti mancano @GetAmountForFreeShipping().ToString("C", CultureInfo.GetCultureInfo("it-IT")) per
                            ottenere la spedizione gratuita con @SelectedShippingOption!.Name.
                        </div>
                    </div>
                }
                else if (SelectedShippingOption is not null && !SelectedShippingOption.IsPickup && GetShipping() == 0)
                {
                    <div class="free-shipping-banner success">
                        <div class="free-shipping-title">Spedizione gratuita applicata</div>
                        <div class="free-shipping-text">
                            Con @SelectedShippingOption.Name la spedizione è gratuita sul tuo ordine attuale.
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Recommended Items -->
        <div class="recommended-section">
            <div class="recommended-header">
                <h2 class="recommended-title">Potrebbe Interessarti Anche</h2>
                <p class="recommended-subtitle">Altri quadri selezionati per te</p>
            </div>

            @if (recommendedPaintings?.Any() == true)
            {
                <div class="recommended-grid">
                    @foreach (var painting in recommendedPaintings.Take(3))
                    {
                        <PaintingCard Title="@painting.Title" Description="@painting.Description" Year="@painting.Year"
                            Medium="@painting.Medium" Price="@painting.Price" IsForSale="@painting.IsForSale"
                            ImageUrls="@painting.ImageUrls" PaintingDto="painting" />
                    }
                </div>
            }
        </div>
    }
</div>