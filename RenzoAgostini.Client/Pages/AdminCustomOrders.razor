@page "/admin/custom-orders"
@using System.Globalization
@using Microsoft.AspNetCore.Authorization
@using RenzoAgostini.Shared.DTOs
@using RenzoAgostini.Shared.Data
@attribute [Authorize(Roles = "admin")]

<PageTitle>Gestione Richieste Personalizzate - Admin</PageTitle>

<div class="admin-container">
	<div class="header">
		<h1>Gestione Richieste Personalizzate</h1>
	</div>

	@if (!string.IsNullOrEmpty(errorMessage))
	{
		<div class="alert alert-danger">
			<p>❌ @errorMessage</p>
		</div>
	}

	@if (!string.IsNullOrEmpty(successMessage))
	{
		<div class="alert alert-success">
			<p>✅ @successMessage</p>
		</div>
	}

	@if (customOrders == null)
	{
		<div class="loading">Caricamento...</div>
	}
	else if (!customOrders.Any())
	{
		<div class="empty-state">
			<p>📝 Nessuna richiesta personalizzata al momento</p>
		</div>
	}
	else
	{
		<!-- Filtri -->
		<div class="filters">
			<select class="filter-select" @onchange="FilterOrders">
				<option value="">Tutti gli stati</option>
				<option value="@CustomOrderStatus.Pending">In Attesa</option>
				<option value="@CustomOrderStatus.Accepted">Accettate</option>
				<option value="@CustomOrderStatus.Completed">Completate</option>
				<option value="@CustomOrderStatus.Rejected">Rifiutate</option>
			</select>
		</div>

		<!-- Tabella richieste -->
		<div class="table-container">
			<table class="custom-orders-table">
				<thead>
					<tr>
						<th>ID</th>
						<th>Cliente</th>
						<th>Stato</th>
						<th>Data Richiesta</th>
						<th>Prezzo Quotato</th>
						<th>Codice Accesso</th>
						<th>Azioni</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var order in filteredOrders)
					{
						<tr class="@GetRowClass(order.Status)">
							<td>@order.Id</td>
							<td>
								<a href="mailto:@order.CustomerEmail">@order.CustomerEmail</a>
							</td>
							<td>
								<span class="status-badge @GetStatusClass(order.Status)">
									@GetStatusLabel(order.Status)
								</span>
							</td>
							<td>@order.CreatedAt.ToString("dd/MM/yyyy HH:mm", CultureInfo.GetCultureInfo("it-IT"))</td>
							<td>
								@if (order.QuotedPrice.HasValue)
								{
									@order.QuotedPrice.Value.ToString("C", CultureInfo.GetCultureInfo("it-IT"))
								}
								else
								{
									<span class="text-muted">-</span>
								}
							</td>
							<td>
								<code class="access-code">@order.AccessCode</code>
							</td>
							<td>
								<div class="action-buttons">
									<button class="btn-small primary" @onclick="() => ShowDetails(order)">
										👁️ Dettagli
									</button>
									@if (order.Status == CustomOrderStatus.Pending)
									{
										<button class="btn-small success" @onclick="() => ShowAcceptModal(order)">
											✅ Accetta
										</button>
										<button class="btn-small danger" @onclick="() => ShowRejectModal(order)">
											❌ Rifiuta
										</button>
									}
									@if (order.PaintingId.HasValue)
									{
										<button class="btn-small secondary" @onclick="() => ViewPainting(order.PaintingId.Value)">
											🎨 Vedi Quadro
										</button>
									}
								</div>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	}

	<!-- Modal Dettagli -->
	@if (showDetailsModal && selectedOrder != null)
	{
		<div class="modal-overlay" @onclick="CloseDetailsModal">
			<div class="modal large" @onclick:stopPropagation="true">
				<div class="modal-header">
					<h2>Dettagli Richiesta #@selectedOrder.Id</h2>
					<button class="btn-close" @onclick="CloseDetailsModal">✕</button>
				</div>
				<div class="modal-body">
					<div class="details-grid">
						<div class="detail-section">
							<h3>Informazioni Cliente</h3>
							<p><strong>Email:</strong> <a href="mailto:@selectedOrder.CustomerEmail">@selectedOrder.CustomerEmail</a></p>
							<p><strong>Data richiesta:</strong> @selectedOrder.CreatedAt.ToString("dd/MM/yyyy HH:mm", CultureInfo.GetCultureInfo("it-IT"))</p>
							<p><strong>Codice accesso:</strong> <code>@selectedOrder.AccessCode</code></p>
						</div>

						<div class="detail-section">
							<h3>Descrizione del Quadro</h3>
							<div class="description-box">
								@selectedOrder.Description
							</div>
						</div>

						@if (!string.IsNullOrEmpty(selectedOrder.AttachmentOriginalName))
						{
							<div class="detail-section">
								<h3>Allegato</h3>
								<p>📎 @selectedOrder.AttachmentOriginalName</p>
								<button class="btn-small secondary" @onclick="() => DownloadAttachment(selectedOrder.Id)">
									⬇️ Scarica
								</button>
							</div>
						}

						@if (!string.IsNullOrEmpty(selectedOrder.ArtistNotes))
						{
							<div class="detail-section">
								<h3>Note dell'Artista</h3>
								<div class="notes-box">
									@selectedOrder.ArtistNotes
								</div>
							</div>
						}
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn secondary" @onclick="CloseDetailsModal">Chiudi</button>
				</div>
			</div>
		</div>
	}

	<!-- Modal Accettazione -->
	@if (showAcceptModal && selectedOrder != null)
	{
		<div class="modal-overlay" @onclick="CloseAcceptModal">
			<div class="modal" @onclick:stopPropagation="true">
				<div class="modal-header">
					<h2>Accetta Richiesta #@selectedOrder.Id</h2>
					<button class="btn-close" @onclick="CloseAcceptModal">✕</button>
				</div>
				<div class="modal-body">
					<EditForm Model="@acceptForm" OnValidSubmit="@AcceptOrder" FormName="AcceptForm">
						<DataAnnotationsValidator />

						<div class="form-group">
							<label>Prezzo Quotato (€) *</label>
							<InputNumber @bind-Value="acceptForm.QuotedPrice" class="form-control" step="0.01" />
							<ValidationMessage For="@(() => acceptForm.QuotedPrice)" />
						</div>

						<div class="form-group">
							<label>Note per il Cliente</label>
							<InputTextArea @bind-Value="acceptForm.ArtistNotes" class="form-control" rows="3"
										   placeholder="Eventuali note o dettagli aggiuntivi..." />
						</div>

						<!-- Dati del quadro -->
						<h3>Dati del Quadro da Creare</h3>

						<div class="form-group">
							<label>Titolo *</label>
							<InputText @bind-Value="acceptForm.PaintingData.Title" class="form-control" />
							<ValidationMessage For="@(() => acceptForm.PaintingData.Title)" />
						</div>

						<div class="form-group">
							<label>Slug *</label>
							<InputText @bind-Value="acceptForm.PaintingData.Slug" class="form-control"
									   placeholder="es: quadro-personalizzato-cliente" />
							<ValidationMessage For="@(() => acceptForm.PaintingData.Slug)" />
						</div>

						<div class="form-group">
							<label>Descrizione</label>
							<InputTextArea @bind-Value="acceptForm.PaintingData.Description" class="form-control" rows="3" />
						</div>

						<div class="form-row">
							<div class="form-group">
								<label>Anno</label>
								<InputNumber @bind-Value="acceptForm.PaintingData.Year" class="form-control" />
							</div>
							<div class="form-group">
								<label>Tecnica</label>
								<InputText @bind-Value="acceptForm.PaintingData.Medium" class="form-control" />
							</div>
						</div>

						<div class="form-group">
							<label>Dimensioni</label>
							<InputText @bind-Value="acceptForm.PaintingData.Dimensions" class="form-control"
									   placeholder="es: 50x70 cm" />
						</div>

						<div class="modal-footer">
							<button type="button" class="btn secondary" @onclick="CloseAcceptModal">Annulla</button>
							<button type="submit" class="btn success" disabled="@isProcessingAccept">
								@if (isProcessingAccept)
								{
									<span>Elaborazione...</span>
								}
								else
								{
									<span>✅ Accetta e Crea Quadro</span>
								}
							</button>
						</div>
					</EditForm>
				</div>
			</div>
		</div>
	}

	<!-- Modal Rifiuto -->
	@if (showRejectModal && selectedOrder != null)
	{
		<div class="modal-overlay" @onclick="CloseRejectModal">
			<div class="modal" @onclick:stopPropagation="true">
				<div class="modal-header">
					<h2>Rifiuta Richiesta #@selectedOrder.Id</h2>
					<button class="btn-close" @onclick="CloseRejectModal">✕</button>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>Motivo del Rifiuto (opzionale)</label>
						<textarea @bind="rejectReason" class="form-control" rows="4"
								  placeholder="Spiega al cliente il motivo del rifiuto..."></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn secondary" @onclick="CloseRejectModal">Annulla</button>
					<button class="btn danger" @onclick="RejectOrder" disabled="@isProcessingReject">
						@if (isProcessingReject)
						{
							<span>Elaborazione...</span>
						}
						else
						{
							<span>❌ Conferma Rifiuto</span>
						}
					</button>
				</div>
			</div>
		</div>
	}
</div>  